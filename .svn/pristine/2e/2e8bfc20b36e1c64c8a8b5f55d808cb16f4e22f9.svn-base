webpackJsonp([18],{"3Geq":function(t,e){},"4Hn/":function(t,e){},kYvM:function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=a("Gu7T"),s=a.n(i),n=a("CFN8"),o={data:function(){return{tableData:{data:[],columns:[{title:"事件发生时间",key:"event_time"},{title:"事件类型",key:"name"},{title:"事件属性",key:"event_attributes",ellipsis:!0,tooltip:!0}]},total:0,currentPage:1,userinfo:[],loading:!1,userId:"",loadingOrNoData:"数据加载中...",list:[],columns_info:[{title:"text_0",key:"text_0",ellipsis:!0,tooltip:!0},{title:"text_1",key:"text_1",ellipsis:!0,tooltip:!0},{title:"text_2",key:"text_2",ellipsis:!0,tooltip:!0},{title:"text_3",key:"text_3",ellipsis:!0,tooltip:!0}]}},components:{editTitle:n.a},mounted:function(){var t=this;this.$tools.bus.$on("userInfo",function(e){t.userId=e,t.getData(e)})},beforeDestroy:function(){this.$tools.bus.$off("userInfo")},methods:{getData:function(t){var e=this;this.loading=!0,this.loadingOrNoData="数据加载中...",this.$axios.get(this.$config.apiDomain+"/user-profile/"+t).then(function(t){var a=t.data;a.forEach(function(t,a){var i=[];t.trait_list.forEach(function(t,a){var s=Math.floor(a/4);a%4==0&&i.push({}),e.$set(i[s],"text_"+a%4,t.name+" : "+(t.value||""))}),e.list[a]=i}),e.userinfo=a}).catch(function(t){});var a={page:this.currentPage||1};this.$axios.get(this.$config.apiDomain+"/user-profile/behaviour/"+t,{params:a}).then(function(t){var a=t.data;e.tableData.data=[],a.items.length||(e.loadingOrNoData="暂无数据"),a.items.forEach(function(t){var a=[];t.trait_list.forEach(function(t){a.push(t.name+":【"+(t.value||"")+"】")}),e.tableData.data.push({name:t.event_info.name,event_time:t.event_info.event_time,event_attributes:a.join("\n")})}),e.total=a.total,e.loading=!1}).catch(function(t){e.tableData.data=[],e.total=0,e.loadingOrNoData="数据加载失败",e.loading=!1})},userPageChange:function(t){this.currentPage=t,this.getData(this.userId)}},watch:{}},r={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"mask-bg"},[a("edit-title",{attrs:{title:"用户详情",isShowBtn:!1}}),t._v(" "),a("div",{staticClass:"custom-dialog-content"},[a("div",{staticClass:"userContent dialog-padding20 f12"},[a("Card",{attrs:{"dis-hover":""}},[a("p",{attrs:{slot:"title"},slot:"title"},[a("Icon",{staticClass:"big-icon",attrs:{type:"ios-contact"}}),t._v(" "),a("span",[t._v(t._s(t.userId))])],1),t._v(" "),t._l(t.userinfo,function(e,i){return a("div",{key:i,staticClass:"s-null"},[a("Icon",{staticClass:"small-icon",attrs:{type:"md-ionic"}}),t._v(" "),a("strong",[t._v(t._s(e.group_name))]),t._v(" "),a("Table",{staticClass:"user-info smce-table-noscroll td-table-no-border",attrs:{columns:t.columns_info,data:t.list[i],"show-header":!1,"disabled-hover":!0}})],1)})],2),t._v(" "),a("br"),t._v(" "),a("Card",{staticClass:"pb20",attrs:{"dis-hover":""}},[a("p",{attrs:{slot:"title"},slot:"title"},[a("Icon",{staticClass:"big-icon",attrs:{type:"android-cart"}}),t._v("  全部行为\n                ")],1),t._v(" "),a("Table",{staticClass:"smce-table-noscroll",attrs:{columns:t.tableData.columns,data:t.tableData.data,"no-data-text":t.loadingOrNoData,loading:t.loading}}),t._v(" "),a("Page",{staticClass:"page-style",attrs:{total:t.total,"show-elevator":"",current:t.currentPage},on:{"on-change":t.userPageChange}})],1)],1)])],1)},staticRenderFns:[]};var l=a("VU/8")(o,r,!1,function(t){a("4Hn/"),a("kjq/")},"data-v-76ecad7e",null).exports,c=a("mw3O"),u=a.n(c),d=a("d32x"),h={props:{title:{type:String,default:""},customizeData:{type:Object,default:{}}},data:function(){return{submitLoading:!1,trait_params:{publicTrait:!0,value:{}},event_params:{scope:"event",publicTrait:!1,value:{},isGetCatalogs:!1,common:{code:"",name:"属性"}},traitURL:{traitsParams:{lifecycle_status:"active",data_type:["String","Number","Bool","Date","Address","Enum","Badge","StringSet"],authorized:!1},searchParams:{visibility:"public",authorized:!1,lifecycle_status:"active",data_type:["String","Number","Bool","Date","Address","Enum","Badge","StringSet"]},catalogsParams:{authorized:!1}},eventURL:{},objectAndDefine:{value:[],names:[]},eventTypeList:[],dataBack:{},formValidate:{userList:{},traitModuleList:[],eventModuleList:[],traitModuleDefine:[],eventModuleDefine:[]}}},computed:{hasChanged:function(){return this.$lodash.isEqual(this.dataCollation(),this.dataBack)}},components:{editTitle:n.a,TraitInput:d.a},mounted:function(){this.getData(),this.dataBack=this.$lodash.cloneDeep(this.dataCollation())},methods:{dataCollation:function(){var t=this.$lodash.cloneDeep(this.formValidate.traitModuleList);t.forEach(function(t){t.trait_list=t.trait_list.map(function(t){return t.code}).sort()});var e=this.$lodash.cloneDeep(this.formValidate.eventModuleList);return e.forEach(function(t){t.trait_list=t.trait_list.map(function(t){return t.code}).sort()}),{userList:this.$lodash.cloneDeep(this.objectAndDefine.value).sort(),traitModule:t,eventModule:e}},setEventURL:function(t){return{traits:this.$config.apiDomain+"/events/"+t.event_info.code+"/traits",search:this.$config.apiDomain+"/events/"+t.event_info.code+"/traits",searchParams:{size:-1}}},getData:function(){var t=this;if(this.customizeData.list_view_traits&&this.customizeData.list_view_traits.trait_list&&(this.formValidate.userList={trait_list:[]},this.customizeData.list_view_traits.trait_list.forEach(function(e){t.objectAndDefine.value.push(e.code),t.objectAndDefine.names.push(e.name),t.formValidate.userList.trait_list.push({code:e.code})})),this.customizeData.detail_view_traits=this.customizeData.detail_view_traits||[],this.customizeData.detail_view_traits.length){var e=[];this.customizeData.detail_view_traits.forEach(function(a,i){t.formValidate.traitModuleList.push({group_name:a.group_name,trait_list:[]}),e[i]={value:[],names:[]},a.trait_list.forEach(function(a){e[i].value.push(a.code),e[i].names.push(a.name),t.formValidate.traitModuleList[i].trait_list.push({code:a.code})})}),this.formValidate.traitModuleDefine=e}if(this.customizeData.events=this.customizeData.events||[],this.customizeData.events.length){var a=[];this.customizeData.events.forEach(function(e,i){e.event_info=e.event_info||{},e.trait_list=e.trait_list||[],a[i]={value:[],names:[]},t.formValidate.eventModuleList.push({trait_list:[],event_info:{code:e.event_info.code}}),e.trait_list.forEach(function(e){a[i].value.push(e.code),a[i].names.push(e.name),t.formValidate.eventModuleList[i].trait_list.push({code:e.code})})}),this.formValidate.eventModuleDefine=a}this.$axios.get(this.$config.apiDomain+"/events",{params:{authorized:!1,size:-1,event_type:["business_event"]},paramsSerializer:function(t){return u.a.stringify(t,{indices:!1})}}).then(function(e){var a=e.data;t.eventTypeList=a.items,t.eventTypeList.forEach(function(t){t.value=t.code,t.label=t.name})})},cancel:function(){this.$emit("cancelUserConfiguration",!1)},ok:function(){for(var t=this,e=!0,a=this.formValidate.traitModuleList,i=this.formValidate.eventModuleList,s=0;s<a.length;s++){if(""==a[s].group_name)return this.$Message.destroy(),this.$Message.error("请补全组合"+(s+1)+" 名称"),void(e=!1);if(!this.$config.reg_input.reg.test(a[s].group_name))return this.$Message.destroy(),this.$Message.error("只支持中英文、数字、下划线，请正确填写"),e=!1,!1}for(var n=0;n<i.length;n++)if(""==i[n].event_info.code||void 0==i[n].event_info.code)return this.$Message.destroy(),this.$Message.error("请选择事件"+(n+1)),e=!1,!1;if(e){var o={events:this.formValidate.eventModuleList,list_view_traits:this.formValidate.userList,detail_view_traits:this.formValidate.traitModuleList};this.submitLoading=!0,this.$axios.put(this.$config.apiDomain+"/user-profile-config",o).then(function(){t.submitLoading=!1,t.$Message.success("已提交"),t.$emit("submitCreateUnit",!1)}).catch(function(e){t.submitLoading=!1})}},setObject:function(t,e,a){var i=this;if("userList"===e){if(t.names.length>4)return;this.objectAndDefine=this.$lodash.cloneDeep(t),this.formValidate.userList={trait_list:[]},t.value.forEach(function(t){i.formValidate.userList.trait_list.push({code:t})})}else{if("traitModule"===e){if(t.names.length>8)return}else if("eventModule"===e&&t.names.length>3)return;this.formValidate[e+"Define"].splice(a,1,this.$lodash.cloneDeep(t)),this.formValidate[e+"List"][a].trait_list=[],t.value.forEach(function(t){i.formValidate[e+"List"][a].trait_list.push({code:t})})}},setTraitlist:function(t){return this.setObject(t,"userList")},setTraitModule:function(t,e){return this.setObject(t,"traitModule",e)},setEventModule:function(t,e){return this.setObject(t,"eventModule",e)},addTraitCombination:function(){if(this.formValidate.traitModuleList.length>2)return this.$Message.destroy(),this.$Message.error("最多添加3个组合");this.formValidate.traitModuleList.push({group_name:"",trait_list:[]}),this.formValidate.traitModuleDefine.push({value:"",names:""})},addEventCombination:function(){if(this.formValidate.eventModuleList.length>2)return this.$Message.destroy(),this.$Message.error("最多添加3个组合");this.formValidate.eventModuleList.push({trait_list:[],event_info:{code:""}}),this.formValidate.eventModuleDefine.push({value:"",names:""})},delModule:function(t,e){var a=this,i=!1,s=t.event_info?"event":"trait";this.$Modal.confirm({title:"提示",content:"确认删除"+("event"===s?"事件":"特性")+"组合"+(e+1)+"吗?",loading:!0,onOk:function(){i||(a.formValidate[s+"ModuleList"].splice(e,1),a.formValidate[s+"ModuleDefine"].splice(e,1),i=!0,a.$Modal.remove())}})},changeEvent:function(t,e){var a=t.event_info.code,i=[];this.formValidate.eventModuleList[e].trait_list=[],this.formValidate.eventModuleList.forEach(function(t){i.push(t.event_info.code)}),i.splice(e,1);var s=-1!==i.indexOf(a);if(this.formValidate.eventModuleDefine[e]={value:"",names:""},s)return this.formValidate.eventModuleList[e].trait_list=[],this.formValidate.eventModuleList[e].event_info.code=null,void this.$Message.error("事件"+(e+1)+"选择重复");this.eventURL={traits:this.$config.apiDomain+"/events/"+a+"/traits",search:this.$config.apiDomain+"/events/"+a+"/traits",searchParams:{size:-1}}}},watch:{},destroyed:function(){}},f={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"mask-bg"},[a("edit-title",{attrs:{loading:t.submitLoading,title:t.title,disabled:t.hasChanged},on:{"cancel-click":t.cancel,"ok-click":t.ok}}),t._v(" "),a("div",{staticClass:"custom-dialog-content"},[a("div",{staticClass:" m20"},[a("Card",{staticClass:"mb10 ",attrs:{"dis-hover":""}},[a("p",{attrs:{slot:"title"},slot:"title"},[t._v("用户列表")]),t._v(" "),a("TraitInput",t._b({attrs:{closable:!0,count:4,btnType:!0,URI:t.traitURL,isShowTagList:!0,multiple:!0,value:t.objectAndDefine},on:{"on-change":t.setTraitlist}},"TraitInput",t.trait_params,!1))],1),t._v(" "),a("Card",{attrs:{"dis-hover":""}},[a("p",{attrs:{slot:"title"},slot:"title"},[t._v("用户详情")]),t._v(" "),a("Card",{staticClass:"mb20",attrs:{"dis-hover":""}},[a("p",{attrs:{slot:"title"},slot:"title"},[t._v("特性组合模块(最多添加3个特性模块)")]),t._v(" "),a("a",{attrs:{slot:"extra",href:"#"},on:{click:function(e){return e.preventDefault(),t.changeLimit(e)}},slot:"extra"}),t._v(" "),t._l(t.formValidate.traitModuleList,function(e,i){return a("div",{key:i},[a("Row",{staticClass:"mt10 line-height30"},[a("Col",{attrs:{span:"2"}},[t._v(" 组合"+t._s(i+1)+"名称\n                            ")]),t._v(" "),a("Col",{attrs:{span:"20"}},[a("Input",{staticClass:"width500",attrs:{maxlength:20,placeholder:"请输入组合名称"},model:{value:e.group_name,callback:function(a){t.$set(e,"group_name","string"==typeof a?a.trim():a)},expression:"item.group_name"}})],1),t._v(" "),a("Col",{attrs:{span:"1",offset:"1"}},[a("Icon",{attrs:{type:"ios-trash",size:"18"},on:{click:function(a){t.delModule(e,i)}}})],1)],1),t._v(" "),a("Row",{staticClass:"mt10 mb10 line-height30"},[a("Col",{attrs:{span:"2"}},[t._v(" 添加特性\n                            ")]),t._v(" "),a("Col",{attrs:{span:"20"}},[a("TraitInput",t._b({attrs:{placeholder:"添加特性",closable:!0,count:8,btnType:!0,URI:t.traitURL,isShowTagList:!0,multiple:!0,value:t.formValidate.traitModuleDefine[i]},on:{"on-change":function(e){return t.setTraitModule(e,i)}}},"TraitInput",t.trait_params,!1))],1)],1),t._v(" "),a("hr",{staticClass:"hr"})],1)}),t._v(" "),a("Button",{on:{click:t.addTraitCombination}},[t._v("添加特性组合模块")])],2),t._v(" "),a("Card",{attrs:{"dis-hover":""}},[a("p",{attrs:{slot:"title"},slot:"title"},[t._v("行为事件模块(最多添加3个事件模块)")]),t._v(" "),t._l(t.formValidate.eventModuleList,function(e,i){return a("div",{key:i},[a("Row",{staticClass:"mt10 line-height30"},[a("Col",{attrs:{span:"2"}},[t._v(" 事件"+t._s(i+1)+"\n                            ")]),t._v(" "),a("Col",{attrs:{span:"20"}},[a("Select",{staticStyle:{width:"200px"},on:{"on-change":function(a){t.changeEvent(e,i)}},model:{value:t.formValidate.eventModuleList[i].event_info.code,callback:function(e){t.$set(t.formValidate.eventModuleList[i].event_info,"code",e)},expression:"formValidate.eventModuleList[index].event_info.code"}},[t._v(t._s(e)+"\n                                "),t._l(t.eventTypeList,function(e){return a("Option",{key:e.value,attrs:{value:e.value}},[t._v(t._s(e.label))])})],2)],1),t._v(" "),a("Col",{attrs:{span:"1",offset:"1"}},[a("Icon",{attrs:{type:"ios-trash",size:"18"},on:{click:function(a){t.delModule(e,i)}}})],1)],1),t._v(" "),a("Row",{staticClass:"mt10 mb10 line-height30"},[a("Col",{attrs:{span:"2"}},[t._v(" 添加属性\n                            ")]),t._v(" "),a("Col",{attrs:{span:"20"}},[a("TraitInput",t._b({attrs:{disabled:!t.formValidate.eventModuleList[i].event_info.code,btnText:"属性",closable:!0,count:3,btnType:!0,URI:t.setEventURL(e),isShowTagList:!0,multiple:!0,value:t.formValidate.eventModuleDefine[i]},on:{"on-change":function(e){return t.setEventModule(e,i)}}},"TraitInput",t.event_params,!1))],1)],1),t._v(" "),a("hr",{staticClass:"hr"})],1)}),t._v(" "),a("Button",{on:{click:t.addEventCombination}},[t._v("添加行为事件模块")])],2)],1)],1)])],1)},staticRenderFns:[]};var v={data:function(){return{crowd_list:[],crowd_option:"all",search_name:"",total:0,current_page:1,detail:!1,user_id:"",crowd_id:"",usercolumns:[],user_data:[],loading:!1,max_page:0,debounceSearch:null,debouncePage:null,userConfiguration:!1,customizeData:{},loadingOrNoData:"数据加载中..."}},computed:{},components:{Content:l,Configuration:a("VU/8")(h,f,!1,function(t){a("3Geq")},"data-v-2d73a43a",null).exports},created:function(){this.debounceSearch=this.$lodash.debounce(this.searIconClick,this.$config.debounce_wait),this.debouncePage=this.$lodash.debounce(this.changePage,this.$config.debounce_wait)},mounted:function(){this.getCrowdList()},methods:{getCrowdList:function(){var t=this;this.$axios.get(this.$config.apiDomain+"/crowds/drop/list/visible").then(function(e){var a=e.data;a.items.length||(t.loadingOrNoData="暂无数据"),a.items.forEach(function(t){t.value=t.id,t.label=t.name}),t.crowd_list=a.items,t.getData()}).catch(function(){t.loadingOrNoData="数据加载失败"})},getData:function(){var t=this;this.loading=!0,this.loadingOrNoData="数据加载中...",this.$axios.get(this.$config.apiDomain+"/user-profile-config").then(function(e){var a=e.data;if(a){if(t.usercolumns=[{title:"UID",key:"uid",ellipsis:!0,tooltip:!0},{title:"操作",align:"center",ellipsis:!0,tooltip:!0,render:function(e,a){return e("a",{on:{click:function(){t.openDetails(a.index,a.row)}}},"详情")}}],t.customizeData=a,a.list_view_traits.trait_list.length){var i;a.list_view_traits.trait_list.forEach(function(t){t.title=t.name,t.key=t.code,t.ellipsis=!0,t.tooltip=!0});var n=a.list_view_traits.trait_list;(i=t.usercolumns).splice.apply(i,[1,0].concat(s()(n)))}else t.loadingOrNoData="暂无数据";t.loading=!1}}).catch(function(){t.loadingOrNoData="数据加载失败",t.loading=!1}),this.changeCrowdList(this.crowd_option)},changeCrowdList:function(t){this.current_page=1,this.crowd_id="all"===t?"":t,this.getTableData(this.crowd_id)},getTableData:function(t){var e=this;this.loading=!0,this.loadingOrNoData="数据加载中...";var a={crowdId:t||this.crowd_id,page:this.current_page||1,q:this.search_name||""};this.$axios.get(this.$config.apiDomain+"/user-profile/info",{params:a}).then(function(t){var a=t.data;a.items.length||(e.loadingOrNoData="暂无数据"),e.user_data=a.items,e.total=a.total,e.max_page=a.max_page||9999999,e.loading=!1}).catch(function(){e.user_data=[],e.total=0,e.loadingOrNoData="数据加载失败",e.loading=!1})},sortChange:function(){},changePage:function(t){this.current_page=t,this.getTableData(this.crowd_id)},searIconClick:function(){this.current_page=1,this.getTableData(this.crowd_id)},openDetails:function(t,e){this.detail=!0,this.user_id=e.uid,this.$tools.bus.$emit("userInfo",this.user_id)},cancel:function(t){this.userConfiguration=t},submit:function(){this.userConfiguration=!1,this.getData()}},watch:{}},_={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"page-warpper"},[a("div",{staticClass:"page-title bottom-shadow page-title-tab"},[a("Menu",{staticClass:"pl24",attrs:{mode:"horizontal",theme:"light","active-name":"insight"}},[a("MenuItem",{attrs:{name:"insight"}},[t._v("用户档案")])],1)],1),t._v(" "),a("div",{staticClass:"userSarchives page-content page-content-tab container-padding24"},[a("Card",{attrs:{"dis-hover":"",padding:0}},[a("Row",{staticClass:"padding16-18"},[a("Col",{attrs:{span:"20"}},[a("Select",{staticClass:"width300",attrs:{filterable:"",placeholder:"请选择全部人群"},on:{"on-change":t.changeCrowdList},model:{value:t.crowd_option,callback:function(e){t.crowd_option=e},expression:"crowd_option"}},[a("Option",{attrs:{value:"all"}},[t._v("全部人群包")]),t._v(" "),t._l(t.crowd_list,function(e){return a("Option",{key:e.value,attrs:{value:e.value}},[t._v(t._s(e.label))])})],2),t._v(" "),a("Input",{staticClass:"dependant-search",attrs:{placeholder:"请输入关键字搜索",icon:"ios-search"},on:{"on-change":t.debounceSearch},nativeOn:{keyup:function(e){return"button"in e||!t._k(e.keyCode,"enter",13,e.key,"Enter")?t.debounceSearch(e):null}},model:{value:t.search_name,callback:function(e){t.search_name=e},expression:"search_name"}}),t._v(" "),a("span",{staticClass:"total-count"},[t._v("共"),a("i",[t._v(t._s(t._f("formatAmount")(t.total)))]),t._v("个人")])],1),t._v(" "),a("Col",{staticStyle:{"text-align":"right"},attrs:{span:"4"}},[a("Button",{directives:[{name:"role-button",rawName:"v-role-button",value:"user_profile_conf_button",expression:"`user_profile_conf_button`"}],attrs:{type:"primary"},on:{click:function(e){t.userConfiguration=!0}}},[t._v("档案配置")]),t._v(" "),a("Drawer",{attrs:{width:"1000","mask-closable":!1},model:{value:t.userConfiguration,callback:function(e){t.userConfiguration=e},expression:"userConfiguration"}},[t.userConfiguration?a("Configuration",{attrs:{title:"档案配置",customizeData:t.customizeData},on:{cancelUserConfiguration:t.cancel,submitCreateUnit:t.submit}}):t._e()],1)],1)],1),t._v(" "),a("div",[a("Table",{staticClass:"smce-table-noscroll td-table-no-border",attrs:{columns:t.usercolumns,data:t.user_data,"no-data-text":t.loadingOrNoData,loading:t.loading},on:{"on-sort-change":t.sortChange}}),t._v(" "),a("Row",{staticClass:"pageRow padding16-18",attrs:{type:"flex",justify:"end"}},[a("Page",{attrs:{total:t.total>10*t.max_page?10*t.max_page:t.total,"page-size":10,"show-elevator":"",current:t.current_page},on:{"on-change":t.debouncePage}})],1),t._v(" "),a("Drawer",{attrs:{width:"1200","mask-closable":!1},model:{value:t.detail,callback:function(e){t.detail=e},expression:"detail"}},[a("Content")],1)],1)],1)],1)])},staticRenderFns:[]};var m=a("VU/8")(v,_,!1,function(t){a("u3uy")},"data-v-3a482be6",null);e.default=m.exports},"kjq/":function(t,e){},u3uy:function(t,e){}});