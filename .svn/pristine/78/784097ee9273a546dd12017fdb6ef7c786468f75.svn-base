webpackJsonp([16],{"+eE1":function(t,e,a){"use strict";var i=a("hmnT"),n={props:{formWidth:{type:Number,default:300},createURI:{type:Object,default:function(){return{url:"",type:""}}},editInfo:{type:Object,default:function(){return{}}}},data:function(){return{isDisabled:!1,formValidate:{code:"",name:"",type:"",value:[],description:""},ruleValidate:{code:[{required:!0,message:"请输入属性ID",trigger:"blur"},{pattern:/^[a-z][a-z0-9_]*$/,message:"只支持小写英文字母、数字、下划线，并以小写字母开头",trigger:"blur"}],name:[{required:!0,message:"请输入属性名称",trigger:"blur"},{pattern:this.$config.reg_input.reg,message:this.$config.reg_input.msg,trigger:"blur"}],type:[{required:!0,message:"请选属性类型",trigger:"change"}]},typeList:[],dataBack:{}}},computed:{isString:function(){return"String"===this.formValidate.type||"StringList"===this.formValidate.type},hasChanged:function(){return this.$lodash.isEqual(this.formValidate,this.dataBack)}},components:{MultipleTag:i.a},created:function(){this.getTypes()},mounted:function(){this.editInfo.code&&(this.isDisabled=!0,this.formValidate.name=this.editInfo.name,this.formValidate.type=this.editInfo.data_type,this.formValidate.code=this.editInfo.code,this.formValidate.value=this.isString&&"-"!==this.editInfo.optional_config?this.editInfo.optional_config.split(","):[],this.formValidate.description="-"===this.editInfo.description?"":this.editInfo.description),this.dataBack=this.$lodash.cloneDeep(this.formValidate)},methods:{changeType:function(t){this.formValidate.type=t},getTypes:function(){var t=this;this.$axios.get(this.$config.apiDomain+"/types",{params:{datatype_scope:"event"}}).then(function(e){var a=e.data;t.typeList=a})},changeTag:function(t){this.formValidate.value=t},handleSubmit:function(t){var e=this;this.$refs[t].validate(function(t){t?(e.$emit("changeLoading",!0),e.editAttr()):e.$emit("changeLoading",!1)})},updateList:function(t,e){this.$emit("changeLoading",!1),this.$tools.bus.$emit("hideDrawer"),this.$Message.destroy(),this.$Message.success(t),this.$tools.bus.$emit("updateList",e)},editAttr:function(){var t=this,e=this.formValidate,a="";a=this.editInfo.code?"/properties/"+this.editInfo.code:this.createURI.url;var i={optional_config:this.isString&&e.value.length?{values:e.value}:void 0,trait_code:e.code,trait_description:e.description,trait_display_name:e.name,data_type:e.type};this.$axios({method:this.editInfo.code?"put":"post",url:""+this.$config.apiDomain+a,data:i}).then(function(){var e=t.editInfo.name?"已修改":"已添加";t.updateList(e,!t.editInfo.code),"eventAttr"==t.createURI.type&&t.$emit("updateEvenAttrtList")}).catch(function(){t.$emit("changeLoading",!1)})}},watch:{hasChanged:function(){this.$emit("changed",this.hasChanged)}}},o={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("Form",{ref:"formValidate",attrs:{"label-position":"left","label-width":110,model:t.formValidate,rules:t.ruleValidate}},[a("Form-item",{attrs:{label:"属性ID",prop:"code"}},[a("Input",{staticClass:"width400",attrs:{disabled:t.isDisabled,maxlength:32,placeholder:"请输入属性ID"},model:{value:t.formValidate.code,callback:function(e){t.$set(t.formValidate,"code","string"==typeof e?e.trim():e)},expression:"formValidate.code"}}),t._v(" "),a("Tooltip",{staticClass:"f16 tip",attrs:{transfer:"",content:"仅支持输入小写英文字母、数字、下划线，并以小写字母开头，长度为32字以内，不能跟渠道内其他属性ID重复，新建后不可修改",placement:"right","max-width":"200"}},[a("i",{staticClass:"fa fa-question-circle-o"})])],1),t._v(" "),a("Form-item",{attrs:{label:"属性名称",prop:"name"}},[a("Input",{staticClass:"width400",attrs:{maxlength:20,placeholder:"请输入属性名称"},model:{value:t.formValidate.name,callback:function(e){t.$set(t.formValidate,"name","string"==typeof e?e.trim():e)},expression:"formValidate.name"}}),t._v(" "),a("Tooltip",{staticClass:"f16 tip",attrs:{transfer:"",content:"请输入属性名称，将在选择事件属性时显示，长度为20字以内",placement:"right","max-width":"200"}},[a("i",{staticClass:"fa fa-question-circle-o"})])],1),t._v(" "),a("Form-item",{attrs:{label:"属性类型",prop:"type"}},[a("Select",{staticClass:"width400",attrs:{disabled:t.isDisabled},on:{change:t.changeType},model:{value:t.formValidate.type,callback:function(e){t.$set(t.formValidate,"type",e)},expression:"formValidate.type"}},t._l(t.typeList,function(e){return a("Option",{key:e.code,attrs:{value:e.code}},[t._v(t._s(e.name))])})),t._v(" "),a("Tooltip",{staticClass:"f16 tip",attrs:{transfer:"",content:"选择属性类型，将按照类型解析接收到的事件中的数据，在新建后不可修改",placement:"right","max-width":"200"}},[a("i",{staticClass:"fa fa-question-circle-o"})])],1),t._v(" "),a("Form-item",{attrs:{label:"可选值",prop:"value"}},[t.isString?a("multiple-tag",{staticClass:"width400",attrs:{"is-view":!1,"tag-arr":t.formValidate.value,"tag-placeholder":"请输入可选值",isShowTip:"",canKeyDel:"",tipContent:"将应用于特性算子，在需要匹配文本类的特性值时，提示输入可匹配的可选值","tag-width":400},on:{"change-tag":t.changeTag}}):a("p",[t._v("无需特殊配置")])],1),t._v(" "),a("Form-item",{attrs:{label:"描述",prop:"description"}},[a("Input",{staticClass:"width400",attrs:{maxlength:100,type:"textarea",autosize:{minRows:2,maxRows:3},placeholder:"请输入描述，长度为100字以内"},model:{value:t.formValidate.description,callback:function(e){t.$set(t.formValidate,"description","string"==typeof e?e.trim():e)},expression:"formValidate.description"}})],1)],1)},staticRenderFns:[]};var s=a("VU/8")(n,o,!1,function(t){a("MI3A")},"data-v-5cea4b1d",null);e.a=s.exports},"5aWb":function(t,e){},Ksej:function(t,e){},MI3A:function(t,e){},hIvH:function(t,e){},rrTz:function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=a("mw3O"),n=a.n(i),o=a("CFN8"),s={props:{title:{type:String,default:""}},data:function(){return{saveBtnStatus:!1,formValidate:{code:"",name:"",description:""},ruleValidate:{code:[{required:!0,message:"请输入事件英文ID，长度为32个字以内",trigger:"blur"},{pattern:/^[a-z][a-z0-9_]*$/,message:"只支持小写英文字母、数字、下划线，并以小写字母开头",trigger:"blur"}],name:[{required:!0,message:"请输入事件中文名称，长度为20字以内",trigger:"blur"},{pattern:this.$config.reg_input.reg,message:this.$config.reg_input.msg,trigger:"blur"}]},dataBack:{}}},computed:{hasChanged:function(){return this.$lodash.isEqual(this.formValidate,this.dataBack)}},components:{editTitle:o.a},mounted:function(){this.dataBack=this.$lodash.cloneDeep(this.formValidate)},methods:{cancel:function(){this.$emit("cancelCreatEvent",!1)},ok:function(){var t=this;this.$refs.formValidate.validate(function(e){if(e){t.saveBtnStatus=!0;var a={name:t.formValidate.name,code:t.formValidate.code,description:t.formValidate.description};t.$axios.post(t.$config.apiDomain+"/events",a).then(function(e){var a=e.data;t.saveBtnStatus=!1,t.$Message.destroy(),t.$Message.success("已添加"),t.$emit("submitCreatEvent",a)}).catch(function(){t.saveBtnStatus=!1})}})}},watch:{},destroyed:function(){}},r={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"slide-create-box"},[a("edit-title",{attrs:{loading:t.saveBtnStatus,title:t.title,disabled:t.hasChanged},on:{"cancel-click":t.cancel,"ok-click":t.ok}}),t._v(" "),a("div",{staticClass:"slide-scroll-box dialog-padding20"},[a("Card",{staticClass:"pl20 pr20",attrs:{"dis-hover":""}},[a("Form",{ref:"formValidate",attrs:{"label-position":"left","label-width":110,model:t.formValidate,rules:t.ruleValidate}},[a("Form-item",{attrs:{label:"事件ID",prop:"code"}},[a("Input",{staticClass:"width400",attrs:{maxlength:32,placeholder:"请输入英文ID，长度为32个字以内"},model:{value:t.formValidate.code,callback:function(e){t.$set(t.formValidate,"code","string"==typeof e?e.trim():e)},expression:"formValidate.code"}}),t._v(" "),a("Tooltip",{staticClass:"f16 tip",attrs:{transfer:"",content:"仅支持小写字母、下划线、数字组成，并以小写字母开头，长度为32个字符以内，不能跟其他事件ID重复，新建后不可修改。",placement:"right","max-width":"200"}},[a("i",{staticClass:"fa fa-question-circle-o"})])],1),t._v(" "),a("Form-item",{attrs:{label:"事件名称",prop:"name"}},[a("Input",{staticClass:"width400",attrs:{maxlength:20,placeholder:"请输入事件中文名称，长度为20字以内"},model:{value:t.formValidate.name,callback:function(e){t.$set(t.formValidate,"name","string"==typeof e?e.trim():e)},expression:"formValidate.name"}}),t._v(" "),a("Tooltip",{staticClass:"f16 tip",attrs:{transfer:"",content:"长度为20字以内，不能跟其他事件名称重复。",placement:"right","max-width":"200"}},[a("i",{staticClass:"fa fa-question-circle-o"})])],1),t._v(" "),a("Form-item",{attrs:{label:"事件描述",prop:"description"}},[a("Input",{staticClass:"width400",attrs:{maxlength:100,type:"textarea",autosize:{minRows:2,maxRows:3},placeholder:"请输入事件描述，长度为100字以内"},model:{value:t.formValidate.description,callback:function(e){t.$set(t.formValidate,"description","string"==typeof e?e.trim():e)},expression:"formValidate.description"}})],1)],1)],1)],1)],1)},staticRenderFns:[]},c={data:function(){return{creatEvent:!1,eventData:[],eventDetail:{},titleName:"",loading:!0,evtntTitle:"新建事件",loadingOrNoData:"数据加载中...",debounceSearch:null,debouncePage:null,searInput:"",page:{total:0,pageSize:10,currentPage:1}}},computed:{eventColumns:function(){var t=this,e=[{title:"事件ID",key:"code",ellipsis:!0,tooltip:!0},{title:"事件名称",key:"name",ellipsis:!0,tooltip:!0},{title:"描述",key:"description",ellipsis:!0,tooltip:!0}],a={title:"操作",key:"action",width:120,render:function(e,a){var i="system_event"===a.row.event_type;return e("div",[e("a",{on:{click:function(){t.openDetail(a.row.code)}}},"查看"),e("a",{style:i?{"margin-left":"10px",color:"#999",cursor:"not-allowed"}:{"margin-left":"10px"},on:{click:function(){i||t.deleteEvent(a.row)}}},"删除")])}},i={title:"操作",key:"action",width:120,render:function(e,a){return e("div",[e("a",{on:{click:function(){t.openDetail(a.row.code)}}},"查看")])}};return"ROLE_C_ADMIN"===this.$config.login_info.role_id&&"system_event"!==this.eventDetail.event_type&&e.push(a),"ROLE_D_ADMIN"!=this.$config.login_info.role_id&&"ROLE_D_OPERATOR"!=this.$config.login_info.role_id||e.push(i),e}},components:{CreateEvent:a("VU/8")(s,r,!1,null,null,null).exports},created:function(){this.debounceSearch=this.$lodash.debounce(this.searIconClick,this.$config.debounce_wait),this.debouncePage=this.$lodash.debounce(this.pageChange,this.$config.debounce_wait)},mounted:function(){this.getData()},methods:{getData:function(){var t=this;this.loadingOrNoData="数据加载中...",this.$axios.get(this.$config.apiDomain+"/events",{params:{authorized:!1,size:-1,event_type:["system_event","business_event"],order:"asc",q:this.searInput,page_size:this.page.pageSize,page:this.page.currentPage},paramsSerializer:function(t){return n.a.stringify(t,{indices:!1})}}).then(function(e){var a=e.data;a.items.length?(t.loading=!1,t.eventData=a.items,t.page.total=a.total):(t.loading=!1,t.loadingOrNoData="暂无数据",t.eventData=[])}).catch(function(){t.eventData=[],t.page.total=0,t.loadingOrNoData="数据加载失败",t.loading=!1})},addEvent:function(t){this.titleName=t.code?"修改事件":"新建事件",this.creatEvent=!0},cancelCreat:function(t){this.creatEvent=t},deleteEvent:function(t){var e=this,a=!1;this.$Modal.confirm({title:"确认删除此事件？",content:"事件名称："+t.name,loading:!0,onOk:function(){a||e.$axios.delete(e.$config.apiDomain+"/events/"+t.code).then(function(){a=!0,e.$Modal.remove(),e.$Message.destroy(),e.$Message.success("已删除"),e.getData()}).catch(function(){e.$Modal.remove()})},onCancel:function(){}})},searIconClick:function(){this.page.currentPage=1,this.getData()},pageChange:function(t){this.page.currentPage=t,this.getData()},openDetail:function(t){this.$router.push({path:"/event/detail",query:{code:t}}),this.$tools.bus.$emit("updataEventDetail",!0)},submitCreat:function(){this.creatEvent=!1,this.searInput="",this.getData()},exportEventConfig:function(){window.location.replace(this.$config.apiDomain+"/events/"+this.eventDetail.code+"/export")}},watch:{$route:function(t,e){"/event/detail"===e.path&&this.getData()}}},l={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"event-content-box container-padding24"},[a("Card",{attrs:{"dis-hover":"",padding:0}},[a("Row",{staticClass:"padding16-18",attrs:{type:"flex",justify:"space-between"}},[a("Col",[a("Input",{staticClass:"width300",attrs:{icon:"ios-search",placeholder:"请输入事件ID或事件名称"},on:{"on-change":t.debounceSearch},nativeOn:{keyup:function(e){return"button"in e||!t._k(e.keyCode,"enter",13,e.key,"Enter")?t.debounceSearch(e):null}},model:{value:t.searInput,callback:function(e){t.searInput=e},expression:"searInput"}}),t._v(" "),a("span",{staticClass:"total-count"},[t._v("共"),a("i",[t._v(t._s(t.page.total))]),t._v("个事件")])],1),t._v(" "),a("Col",["ROLE_D_OPERATOR"!=t.$config.login_info.role_id&&"ROLE_D_ADMIN"!=t.$config.login_info.role_id?a("Button",{attrs:{icon:"md-add",type:"primary"},on:{click:function(e){t.addEvent({})}}},[t._v("新建事件")]):t._e()],1)],1),t._v(" "),a("Row",[a("Table",{staticClass:"smce-table-noscroll td-table-no-border",attrs:{loading:t.loading,"no-data-text":t.loadingOrNoData,columns:t.eventColumns,data:t.eventData}})],1),t._v(" "),a("Row",{staticClass:"mt16 padding16-18",attrs:{type:"flex",justify:"end"}},[a("Page",{attrs:{total:t.page.total,pageSize:t.page.pageSize,current:t.page.currentPage,"show-elevator":""},on:{"on-change":t.debouncePage}})],1)],1),t._v(" "),a("Drawer",{attrs:{width:"800","mask-closable":!1},model:{value:t.creatEvent,callback:function(e){t.creatEvent=e},expression:"creatEvent"}},[t.creatEvent?a("create-event",{attrs:{title:t.evtntTitle},on:{cancelCreatEvent:t.cancelCreat,submitCreatEvent:t.submitCreat}}):t._e()],1)],1)},staticRenderFns:[]};var d=a("VU/8")(c,l,!1,function(t){a("hIvH")},"data-v-02ce5c9a",null).exports,u=a("+eE1"),h={data:function(){return{saveBtnStatus:!1,hasChanged:!0,apiUrl:{url:"/properties",type:""}}},props:{titleName:{type:String,default:"新建属性"},editInfo:{type:Object,default:function(){return{}}}},components:{editTitle:o.a,CreateAttribute:u.a},methods:{changed:function(t){this.hasChanged=t},changeLoading:function(t){this.saveBtnStatus=t},cancelEdit:function(){this.$tools.bus.$emit("hideDrawer")},okEdit:function(){this.$refs.createAttr.handleSubmit("formValidate")}}},p={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"slide-create-box"},[a("edit-title",{attrs:{loading:t.saveBtnStatus,disabled:t.hasChanged,title:t.titleName},on:{"cancel-click":t.cancelEdit,"ok-click":t.okEdit}}),t._v(" "),a("div",{staticClass:"dialog-padding20 slide-scroll-box"},[a("Card",{staticClass:"p10",attrs:{"dis-hover":""}},[a("CreateAttribute",{ref:"createAttr",attrs:{createURI:t.apiUrl,editInfo:t.editInfo},on:{changeLoading:t.changeLoading,changed:t.changed}})],1)],1)],1)},staticRenderFns:[]},f={data:function(){var t=this;return{statusConfig:this.$config.status_config,titleName:"",showAttr:!1,editInfo:{},searInput:"",currentPage:1,pageSize:10,total:0,loadingOrNoData:"数据加载中...",isLoading:!1,gridList:{data:[],columns:[{title:"属性ID",key:"code",ellipsis:!0,tooltip:!0},{title:"属性名称",key:"name",ellipsis:!0,tooltip:!0},{title:"属性类型",render:function(e,a){return e("span",t.statusConfig[a.row.data_type])}},{title:"可选值",key:"optional_config",ellipsis:!0,tooltip:!0},{title:"描述",key:"description",ellipsis:!0,tooltip:!0},{title:"关联事件",render:function(t,e){return t("span",(e.row.referenced_by_event||0)+" 个")}},{title:"操作",key:"action",width:120,render:function(e,a){var i=a.row.referenced_by_event;return e("div",[e("a",{on:{click:function(){t.editAttr(a.row)}}},"修改"),e("a",{style:i?{"margin-left":"10px",color:"#999",cursor:"not-allowed"}:{"margin-left":"10px"},on:{click:function(){i||t.confirmDelete(a.row)}}},"删除")])}}]},debouncePage:null,debounceSearch:null}},methods:{searIconClick:function(){this.currentPage=1,this.getData()},confirmDelete:function(t){var e=this;this.$Modal.confirm({title:"确认删除此属性？",content:"属性名称："+t.name+"<br/><br/>删除后将无法恢复。",onOk:function(){e.deleteAttr(t.code)}})},deleteAttr:function(t){var e=this,a="/properties/"+t;this.$axios.delete(""+this.$config.apiDomain+a,{}).then(function(){e.currentPage>1&&1==e.gridList.data.length&&e.currentPage--,e.$Message.destroy(),e.$Message.success("已删除"),e.getData()})},editAttr:function(t){this.titleName=t.code?"修改属性":"新建属性",this.editInfo=t,this.showAttr=!0},getData:function(){var t=this;this.loadingOrNoData="数据加载中...",this.isLoading=!0;var e={q:this.searInput,page:this.currentPage,page_size:this.pageSize,visibility:"public"};this.$axios.get(this.$config.apiDomain+"/traits/event-traits",{params:e}).then(function(e){var a=e.data;t.isLoading=!1,a.items.length||(t.loadingOrNoData="暂无数据"),a.items.forEach(function(t){t.description=t.description||"-",t.optional_config?t.optional_config.values.length||(t.optional_config.values[0]="-"):t.optional_config={values:["-"]},t.optional_config=t.optional_config.values.join(",")}),t.gridList.data=a.items,t.total=a.total}).catch(function(){t.gridList.data=[],t.total=0,t.loadingOrNoData="数据加载失败",t.isLoading=!1})},pageChange:function(t){this.currentPage=t,this.getData()}},components:{CreateEventAttr:a("VU/8")(h,p,!1,null,null,null).exports},beforeDestroy:function(){this.$tools.bus.$off("updateList"),this.$tools.bus.$off("hideDrawer")},created:function(){this.getData(),this.debounceSearch=this.$lodash.debounce(this.searIconClick,this.$config.debounce_wait),this.debouncePage=this.$lodash.debounce(this.pageChange,this.$config.debounce_wait)},mounted:function(){var t=this;this.$tools.bus.$on("updateList",function(e){e&&(t.searInput=""),t.currentPage=1,t.getData()}),this.$tools.bus.$on("hideDrawer",function(){t.showAttr=!1})}},g={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"event-attr-box container-padding24"},[a("Card",{attrs:{"dis-hover":"",padding:0}},[a("Row",{staticClass:"padding16-18"},[a("Col",{attrs:{span:"16"}},[a("Input",{staticClass:"width300",attrs:{icon:"ios-search",placeholder:"请输入属性ID或属性名称"},on:{"on-change":t.debounceSearch},nativeOn:{keyup:function(e){return"button"in e||!t._k(e.keyCode,"enter",13,e.key,"Enter")?t.debounceSearch(e):null}},model:{value:t.searInput,callback:function(e){t.searInput=e},expression:"searInput"}}),t._v(" "),a("span",{staticClass:"total-count"},[t._v("共"),a("i",[t._v(t._s(t.total))]),t._v("个属性")])],1),t._v(" "),a("Col",{staticStyle:{"text-align":"right"},attrs:{span:"8"}},[a("Button",{attrs:{icon:"md-add",type:"primary"},on:{click:function(e){t.editAttr({})}}},[t._v("新建属性")])],1)],1),t._v(" "),a("Row",[a("Table",{staticClass:"smce-table-noscroll td-table-no-border",attrs:{loading:t.isLoading,"no-data-text":t.loadingOrNoData,columns:t.gridList.columns,data:t.gridList.data}})],1),t._v(" "),a("Row",{staticClass:"pageRow padding16-18",attrs:{type:"flex",justify:"end"}},[a("Page",{attrs:{total:t.total,pageSize:t.pageSize,current:t.currentPage,"show-elevator":""},on:{"on-change":t.debouncePage}})],1)],1),t._v(" "),a("Drawer",{attrs:{width:"800","mask-closable":!1},model:{value:t.showAttr,callback:function(e){t.showAttr=e},expression:"showAttr"}},[t.showAttr?a("CreateEventAttr",{attrs:{titleName:t.titleName,editInfo:t.editInfo}}):t._e()],1)],1)},staticRenderFns:[]};var m={data:function(){return{activeName:"Content",tabList:[{value:"事件",name:"Content",type:"event"},{value:"属性",name:"Attribute",type:"event_property"}],isDisable:"event",debounceSelect:null}},methods:{handleSelect:function(t){this.activeName=t}},components:{Content:d,Attribute:a("VU/8")(f,g,!1,function(t){a("Ksej")},"data-v-4d3bc84b",null).exports},created:function(){this.debounceSelect=this.$lodash.debounce(this.handleSelect,this.$config.debounce_wait)}},v={render:function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"event-content"},[a("Menu",{staticClass:"pl24 bottom-shadow",attrs:{mode:"horizontal",theme:"light","active-name":t.activeName},on:{"on-select":t.debounceSelect}},t._l(t.tabList,function(e,i){return a("MenuItem",{directives:[{name:"role-button",rawName:"v-role-button",value:e.type+"_tab",expression:"`${item.type}_tab`"}],key:i,attrs:{name:""+e.name}},[t._v("\n            "+t._s(e.value)+"\n        ")])})),t._v(" "),a("div",{staticClass:"tab-content"},[a(t.activeName,{tag:"component"})],1)],1)},staticRenderFns:[]};var b=a("VU/8")(m,v,!1,function(t){a("5aWb")},"data-v-22776c82",null);e.default=b.exports}});