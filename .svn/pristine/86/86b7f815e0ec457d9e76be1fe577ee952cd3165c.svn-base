webpackJsonp([17],{"+eE1":function(t,e,i){"use strict";var a=i("hmnT"),n={props:{formWidth:{type:Number,default:300},createURI:{type:Object,default:function(){return{url:"",type:""}}},editInfo:{type:Object,default:function(){return{}}}},data:function(){return{isDisabled:!1,formValidate:{code:"",name:"",type:"",value:[],description:""},ruleValidate:{code:[{required:!0,message:"请输入属性ID",trigger:"blur"},{pattern:/^[a-z][a-z0-9_]*$/,message:"只支持小写英文字母、数字、下划线，并以小写字母开头",trigger:"blur"}],name:[{required:!0,message:"请输入属性名称",trigger:"blur"},{pattern:this.$config.reg_input.reg,message:this.$config.reg_input.msg,trigger:"blur"}],type:[{required:!0,message:"请选属性类型",trigger:"change"}]},typeList:[],dataBack:{}}},computed:{isString:function(){return"String"===this.formValidate.type||"StringList"===this.formValidate.type},hasChanged:function(){return this.$lodash.isEqual(this.formValidate,this.dataBack)}},components:{MultipleTag:a.a},created:function(){this.getTypes()},mounted:function(){this.editInfo.code&&(this.isDisabled=!0,this.formValidate.name=this.editInfo.name,this.formValidate.type=this.editInfo.data_type,this.formValidate.code=this.editInfo.code,this.formValidate.value=this.isString&&"-"!==this.editInfo.optional_config?this.editInfo.optional_config.split(","):[],this.formValidate.description="-"===this.editInfo.description?"":this.editInfo.description),this.dataBack=this.$lodash.cloneDeep(this.formValidate)},methods:{changeType:function(t){this.formValidate.type=t},getTypes:function(){var t=this;this.$axios.get(this.$config.apiDomain+"/types",{params:{datatype_scope:"event"}}).then(function(e){var i=e.data;t.typeList=i})},changeTag:function(t){this.formValidate.value=t},handleSubmit:function(t){var e=this;this.$refs[t].validate(function(t){t?(e.$emit("changeLoading",!0),e.editAttr()):e.$emit("changeLoading",!1)})},updateList:function(t,e){this.$emit("changeLoading",!1),this.$tools.bus.$emit("hideDrawer"),this.$Message.destroy(),this.$Message.success(t),this.$tools.bus.$emit("updateList",e)},editAttr:function(){var t=this,e=this.formValidate,i="";i=this.editInfo.code?"/properties/"+this.editInfo.code:this.createURI.url;var a={optional_config:this.isString&&e.value.length?{values:e.value}:void 0,trait_code:e.code,trait_description:e.description,trait_display_name:e.name,data_type:e.type};this.$axios({method:this.editInfo.code?"put":"post",url:""+this.$config.apiDomain+i,data:a}).then(function(){var e=t.editInfo.name?"已修改":"已添加";t.updateList(e,!t.editInfo.code),"eventAttr"==t.createURI.type&&t.$emit("updateEvenAttrtList")}).catch(function(){t.$emit("changeLoading",!1)})}},watch:{hasChanged:function(){this.$emit("changed",this.hasChanged)}}},s={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("Form",{ref:"formValidate",attrs:{"label-position":"left","label-width":110,model:t.formValidate,rules:t.ruleValidate}},[i("Form-item",{attrs:{label:"属性ID",prop:"code"}},[i("Input",{staticClass:"width400",attrs:{disabled:t.isDisabled,maxlength:32,placeholder:"请输入属性ID"},model:{value:t.formValidate.code,callback:function(e){t.$set(t.formValidate,"code","string"==typeof e?e.trim():e)},expression:"formValidate.code"}}),t._v(" "),i("Tooltip",{staticClass:"f16 tip",attrs:{transfer:"",content:"仅支持输入小写英文字母、数字、下划线，并以小写字母开头，长度为32字以内，不能跟渠道内其他属性ID重复，新建后不可修改",placement:"right","max-width":"200"}},[i("i",{staticClass:"fa fa-question-circle-o"})])],1),t._v(" "),i("Form-item",{attrs:{label:"属性名称",prop:"name"}},[i("Input",{staticClass:"width400",attrs:{maxlength:20,placeholder:"请输入属性名称"},model:{value:t.formValidate.name,callback:function(e){t.$set(t.formValidate,"name","string"==typeof e?e.trim():e)},expression:"formValidate.name"}}),t._v(" "),i("Tooltip",{staticClass:"f16 tip",attrs:{transfer:"",content:"请输入属性名称，将在选择事件属性时显示，长度为20字以内",placement:"right","max-width":"200"}},[i("i",{staticClass:"fa fa-question-circle-o"})])],1),t._v(" "),i("Form-item",{attrs:{label:"属性类型",prop:"type"}},[i("Select",{staticClass:"width400",attrs:{disabled:t.isDisabled},on:{change:t.changeType},model:{value:t.formValidate.type,callback:function(e){t.$set(t.formValidate,"type",e)},expression:"formValidate.type"}},t._l(t.typeList,function(e){return i("Option",{key:e.code,attrs:{value:e.code}},[t._v(t._s(e.name))])})),t._v(" "),i("Tooltip",{staticClass:"f16 tip",attrs:{transfer:"",content:"选择属性类型，将按照类型解析接收到的事件中的数据，在新建后不可修改",placement:"right","max-width":"200"}},[i("i",{staticClass:"fa fa-question-circle-o"})])],1),t._v(" "),i("Form-item",{attrs:{label:"可选值",prop:"value"}},[t.isString?i("multiple-tag",{staticClass:"width400",attrs:{"is-view":!1,"tag-arr":t.formValidate.value,"tag-placeholder":"请输入可选值",isShowTip:"",canKeyDel:"",tipContent:"将应用于特性算子，在需要匹配文本类的特性值时，提示输入可匹配的可选值","tag-width":400},on:{"change-tag":t.changeTag}}):i("p",[t._v("无需特殊配置")])],1),t._v(" "),i("Form-item",{attrs:{label:"描述",prop:"description"}},[i("Input",{staticClass:"width400",attrs:{maxlength:100,type:"textarea",autosize:{minRows:2,maxRows:3},placeholder:"请输入描述，长度为100字以内"},model:{value:t.formValidate.description,callback:function(e){t.$set(t.formValidate,"description","string"==typeof e?e.trim():e)},expression:"formValidate.description"}})],1)],1)},staticRenderFns:[]};var o=i("VU/8")(n,s,!1,function(t){i("MI3A")},"data-v-5cea4b1d",null);e.a=o.exports},"+pan":function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=i("d32x"),n=i("CFN8"),s=i("+eE1"),o={props:{title:{type:String,default:""},eventCode:{type:String,default:""}},data:function(){return{hasChangedNew:!1,saveBtnStatus:!1,apiUrl:{url:"/events/"+this.eventCode+"/traits",type:"eventAttr"},attributeType:"old",eventParams:{scope:"event",publicTrait:!1,value:{},isGetCatalogs:!1,common:{code:"",name:"属性"}},objectAndDefine:{value:[],names:[]},URL:{traits:this.$config.apiDomain+"/events/"+this.eventCode+"/event-traits",search:this.$config.apiDomain+"/events/"+this.eventCode+"/event-traits",searchParams:{scope:"event",publicTrait:!1,visibility:"public"}},dataBack:[]}},computed:{hasChanged:function(){return this.$lodash.isEqual(this.$lodash.cloneDeep(this.objectAndDefine.value).sort(),this.dataBack)}},components:{TraitInput:a.a,editTitle:n.a,CreateAttribute:s.a},mounted:function(){this.dataBack=this.$lodash.cloneDeep(this.objectAndDefine.value).sort()},methods:{changeOldNew:function(){this.objectAndDefine={value:[],names:[]}},changed:function(t){this.hasChangedNew=t},changeLoading:function(t){this.saveBtnStatus=t},setTraitlist:function(t){this.objectAndDefine=this.$lodash.cloneDeep(t)},cancel:function(){this.$emit("cancelAttributeConfig",!1)},updateEvenAttrtList:function(){this.$emit("submitAttributeConfig",this.eventCode)},ok:function(){var t=this;if("old"===this.attributeType){if(this.saveBtnStatus=!0,!this.objectAndDefine.value.length)return this.$Message.destroy(),void this.$Message.error("请先添加属性");var e=this.objectAndDefine.value;this.$axios.post(this.$config.apiDomain+"/events/"+this.eventCode+"/relation/trait",e).then(function(e){var i=e.data;t.saveBtnStatus=!1,t.$Message.destroy(),t.$Message.success("已添加"),t.$emit("submitAttributeConfig",i)}).catch(function(){t.saveBtnStatus=!1})}else this.$refs.createAttr.handleSubmit("formValidate")}}},r={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"slide-create-box"},[i("edit-title",{attrs:{loading:t.saveBtnStatus,disabled:"old"===t.attributeType?t.hasChanged:t.hasChangedNew,title:t.title},on:{"cancel-click":t.cancel,"ok-click":t.ok}}),t._v(" "),i("div",{staticClass:"slide-scroll-box dialog-padding20"},[i("Card",{staticClass:"pl20 pr20",attrs:{"dis-hover":""}},[i("div",{staticClass:"mt10 mb20"},[i("span",{staticClass:"mr20"},[t._v(" 配置方式：")]),t._v(" "),i("RadioGroup",{on:{"on-change":t.changeOldNew},model:{value:t.attributeType,callback:function(e){t.attributeType=e},expression:"attributeType"}},[i("Radio",{attrs:{label:"old"}},[i("span",[t._v("选择已有属性添加")])]),t._v(" "),i("Radio",{attrs:{label:"new"}},[i("span",[t._v("自定义新建并添加")])])],1)],1),t._v(" "),"old"===t.attributeType?i("div",{staticClass:"pb200"},[i("Alert",{staticClass:"mb16",attrs:{"show-icon":""}},[t._v("从属性列表中选择已有的属性信息，配置到当前事件中")]),t._v(" "),i("Row",{staticClass:"mt10 mb10"},[i("Col",{staticClass:"line-height30",attrs:{span:"2"}},[t._v("选择属性：")]),t._v(" "),i("Col",{attrs:{span:"22"}},[i("TraitInput",t._b({attrs:{btnText:"添加属性",closable:!0,btnType:!0,URI:t.URL,isShowTagList:!0,multiple:!0,value:t.objectAndDefine},on:{"on-change":t.setTraitlist}},"TraitInput",t.eventParams,!1))],1)],1)],1):t._e(),t._v(" "),"new"===t.attributeType?i("div",[i("Alert",{staticClass:"mb16",attrs:{"show-icon":""}},[t._v("自定义新建属性，将在新建后自动配置到当前事件中，并添加到属性列表中")]),t._v(" "),i("CreateAttribute",{ref:"createAttr",attrs:{createURI:t.apiUrl},on:{updateEvenAttrtList:t.updateEvenAttrtList,changeLoading:t.changeLoading,changed:t.changed}})],1):t._e()])],1)],1)},staticRenderFns:[]},l={props:{},data:function(){return{infoBox:null,scrollHeight:null,headBox:null,tableBox:null,showSpin:!0,title:"配置属性",eventCode:"",loading:!0,eventData:[],loadingOrNoData:"数据加载中...",eventDetail:{},attributeConfig:!1,returnList:{},formValidate:{name:"",description:""},editName:!0,editDescription:!0}},computed:{eventColumns:function(){var t=this,e=[{title:"属性ID",key:"code",ellipsis:!0,tooltip:!0},{title:"属性名称",key:"name",ellipsis:!0,tooltip:!0,width:210},{title:"属性类型",key:"event_type",ellipsis:!0,tooltip:!0,render:function(e,i){return e("span",[e("span",t.$config.status_config[i.row.data_type])])}},{title:"可选值",key:"optional_config_str",ellipsis:!0,tooltip:!0},{title:"描述",key:"description",ellipsis:!0,tooltip:!0}],i={title:"操作",key:"action",render:function(e,i){return e("div",[e("a",{on:{click:function(){t.debounceDelAttribute(i.row)}}},"删除")])}};return"ROLE_C_ADMIN"===this.$config.login_info.role_id&&"system_event"!==this.eventDetail.event_type&&e.push(i),e}},components:{Config:i("VU/8")(o,r,!1,null,null,null).exports,EditInput:i("mps7").a},created:function(){this.debounceDelAttribute=this.$lodash.debounce(this.delAttribute,this.$config.debounce_wait)},mounted:function(){var t=this;this.$tools.bus.$on("updataEventDetail",function(){t.eventDetail={},t.getData(),t.$nextTick(function(){t.resetHead()})}),this.getData(),this.infoBox=document.querySelector(".event-info-box"),this.scrollHeight=document.querySelector(".main-right"),this.headBox=document.querySelector(".head"),this.tableBox=document.querySelector(".table-box"),this.scrollHeight.addEventListener("scroll",this.handleScroll,!1),document.querySelector(".ivu-layout-sider-trigger").addEventListener("click",function(){t.scrollHeight.scrollTop=0},!1)},methods:{handleScroll:function(){this.headBox&&(this.scrollHeight.scrollTop>=this.headBox.offsetHeight?(this.headBox.style.width=this.scrollHeight.offsetWidth+"px",this.infoBox.style.display="none",this.headBox.style.position="fixed",this.headBox.style.zIndex="10",this.tableBox.style.marginTop="100px",this.headBox.style.top="63px"):this.resetHead())},resetHead:function(){this.infoBox.style.display="block",this.headBox.style.position="static",this.headBox.style.width="100%",this.tableBox.style.marginTop="0"},getData:function(){var t=this;this.eventCode=this.$route.query.code,this.loading=!0,this.showSpin=!0,this.loadingOrNoData="数据加载中...",this.$axios.get(this.$config.apiDomain+"/events/"+this.eventCode).then(function(e){var i=e.data;t.updateEvent(i)}).catch(function(){t.showSpin=!1,t.loading=!1,t.loadingOrNoData="数据加载失败",t.eventDetail.eventData=[]}),this.returnList={path:"/event"}},delAttribute:function(t){var e=this,i=!1;this.$Modal.confirm({title:"确认删除此属性？",content:"属性名称："+t.name,loading:!0,onOk:function(){i||e.$axios.delete(e.$config.apiDomain+"/events/"+e.eventCode+"/relation/trait/"+t.code).then(function(t){var a=t.data;e.getData(),i=!0,e.$Modal.remove(),e.$Message.destroy(),e.$Message.success("已删除"),a.traits.length||(e.loadingOrNoData="暂无数据")}).catch(function(){e.$Modal.remove()})},onCancel:function(){}})},submit:function(t){this.attributeConfig=!1,this.getData(t)},cancel:function(t){this.attributeConfig=t},exportEventConfig:function(){window.location.replace(this.$config.apiDomain+"/events/"+this.eventDetail.code+"/export")},editContent:function(){var t=this,e={code:this.eventCode,name:this.formValidate.name||this.eventDetail.name,description:this.formValidate.description};this.$axios.put(this.$config.apiDomain+"/events/"+this.eventCode,e).then(function(e){var i=e.data;t.updateEvent(i),t.$Message.destroy(),t.$Message.success("已修改")}).catch(function(){var e=t.eventDetail,i=e.name,a=e.description;t.formValidate={name:i,description:a}})},changeStatus:function(t,e){this[e]=t},confirmInfo:function(t,e){if("name"===e){if(""===t)return this.$Message.destroy(),this.$Message.error("请输入名称"),void(this.editName=!0);if(this.eventDetail.name===t)return;if(!this.$config.reg_input.reg.test(t))return this.$Message.destroy(),void this.$Message.error("只支持中英文、数字、下划线，请正确填写");this.editName=!0,this.formValidate[e]=t,this.editContent()}"description"===e&&(this.eventDetail.description===t||(this.editDescription=!0,this.formValidate[e]=t,this.editContent()))},cancelEdit:function(t){this.editName=!0,this.editDescription=!0,this.formValidate[t]=this.eventDetail[t]},changeInfo:function(t,e){this.formValidate[e]=t},updateEvent:function(t){this.loading=!1,this.showSpin=!1,this.eventDetail=t,this.formValidate.name=t.name,this.formValidate.description=t.description,t.traits.length?(t.traits.forEach(function(t){t.optional_config_str=t.optional_config&&t.optional_config.values&&t.optional_config.values.length?t.optional_config.values.join():"-"}),this.eventDetail.eventData=t.traits):(this.loadingOrNoData="暂无数据",this.eventDetail.eventData=[])}},watch:{},destroyed:function(){},beforeDestroy:function(){this.scrollHeight.removeEventListener("scroll",this.handleScroll,!1),this.infoBox=null,this.scrollHeight=null,this.headBox=null,this.tableBox=null,this.$tools.bus.$off("updataEventDetail")}},c={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"event-detail"},[i("div",{staticClass:"head bottom-shadow"},[i("Row",{staticStyle:{"line-height":"48px"},attrs:{justify:"center",align:"middle"}},[i("Col",{attrs:{span:"16"}},[i("Breadcrumb",{attrs:{separator:""}},[i("BreadcrumbItem",{attrs:{to:t.returnList}},[i("Icon",{attrs:{type:"md-arrow-back",size:"24",color:"rgba(23,35,61,0.55)"}})],1),t._v(" "),i("Form",{staticClass:"edit-event-name"},[i("edit-input",{directives:[{name:"role-button",rawName:"v-role-button",value:"event_curd_self_def",expression:"`event_curd_self_def`"}],staticClass:"event-name",attrs:{"label-name":"name","default-placeholder":"请输入事件名称",value:t.formValidate.name,"edit-show":t.editName,"show-icon-special":"system_event"!==t.eventDetail.event_type},on:{change:function(e){t.changeInfo(e,"name")},"confirm-info":t.confirmInfo,"cancel-edit":function(e){t.cancelEdit("name")},"change-status":function(e){return t.changeStatus(e,"editName")}}})],1)],1)],1),t._v(" "),i("Col",{staticClass:"text-align-r",attrs:{span:"8"}},[i("Button",{directives:[{name:"role-button",rawName:"v-role-button",value:"export_event_conf_button",expression:"`export_event_conf_button`"}],attrs:{icon:"md-download"},on:{click:t.exportEventConfig}},[t._v("导出事件配置")])],1)],1),t._v(" "),i("div",{staticClass:"event-info-box"},[i("Form",{ref:"formArea",attrs:{"label-position":"left",model:t.formValidate,"label-width":82}},[i("Row",[i("Col",{staticStyle:{width:"900px","margin-bottom":"15px"}},[i("edit-input",{directives:[{name:"role-button",rawName:"v-role-button",value:"event_curd_self_def",expression:"`event_curd_self_def`"}],staticClass:"event-edit",attrs:{width:"800px",textarea:"textarea","label-name":"description","max-length":100,"default-placeholder":"请输入事件描述",value:t.formValidate.description,"edit-show":t.editDescription,"show-icon-special":"system_event"!==t.eventDetail.event_type},on:{change:function(e){t.changeInfo(e,"description")},"confirm-info":t.confirmInfo,"cancel-edit":function(e){t.cancelEdit("description")},"change-status":function(e){return t.changeStatus(e,"editDescription")}}})],1)],1),t._v(" "),i("div",{staticClass:"event-info mb10"},[i("span",{staticClass:"font-key"},[t._v("事件ID：")]),t._v(" "),i("span",{staticClass:"font-value"},[t._v(t._s(t.eventDetail.code))])])],1)],1)],1),t._v(" "),i("div",{staticClass:"container-padding24 table-box"},[i("Card",{attrs:{"dis-hover":""}},[i("Row",[i("Col",{staticStyle:{"text-align":"right"},attrs:{span:"8",offset:"16"}},["system_event"!==t.eventDetail.event_type?i("Button",{directives:[{name:"role-button",rawName:"v-role-button",value:"event_trait_conf_button_self_def",expression:"`event_trait_conf_button_self_def`"}],attrs:{icon:"md-add",type:"primary"},on:{click:function(e){t.attributeConfig=!0}}},[t._v("添加属性")]):t._e()],1)],1),t._v(" "),i("div",{staticClass:"mt16 mb16"},[i("Table",{staticClass:"smce-table-noscroll",attrs:{loading:t.loading,"no-data-text":t.loadingOrNoData,columns:t.eventColumns,data:t.eventDetail.eventData}})],1)],1)],1),t._v(" "),i("Drawer",{attrs:{width:"980","mask-closable":!1},model:{value:t.attributeConfig,callback:function(e){t.attributeConfig=e},expression:"attributeConfig"}},[t.attributeConfig?i("Config",{attrs:{title:t.title,eventCode:t.eventDetail.code},on:{cancelAttributeConfig:t.cancel,submitAttributeConfig:t.submit}}):t._e()],1),t._v(" "),t.showSpin?i("Spin",{attrs:{fix:""}}):t._e()],1)},staticRenderFns:[]};var d=i("VU/8")(l,c,!1,function(t){i("nYlN"),i("Cqk6")},"data-v-dfacf732",null);e.default=d.exports},Cqk6:function(t,e){},MI3A:function(t,e){},nYlN:function(t,e){}});